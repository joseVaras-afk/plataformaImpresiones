<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Solicitudes de Impresi√≥n</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background-color: #f9f9f9;
            padding: 20px;
        }

        table {
            background: #fff;
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        h2 {
            color: #0d6efd;
            margin-bottom: 20px;
        }

        .btn i {
            margin-right: 4px;
        }
    </style>
</head>

<body class="container mt-4">
    <h2>Solicitudes de Impresi√≥n</h2>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Profesor</th>
                <th>Curso</th>
                <th>Asignatura</th>
                <th>Cant Copias</th>
                <th>Archivo</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tabla-solicitudes">
            <tr th:each="solicitud : ${solicitudes}" th:data-id="${solicitud.idSolicitudImpresion}">
                <td th:text="${solicitud.idSolicitudImpresion}"></td>
                <td th:text="${solicitud.funcionario.nombreFuncionario}"></td>
                <td th:text="${solicitud.curso}"></td>
                <td th:text="${solicitud.asignatura.nombreAsignatura}"></td>
                <td th:text="${solicitud.cantidadCopias}"></td>
                <td>
                    <a th:href="@{'/operador/descargar/' + ${solicitud.idSolicitudImpresion}}">Descargar</a>
                </td>
                <td th:text="${solicitud.estado}"></td>
                <td>
                    <button class="btn btn-success btn-impreso" th:data-id="${solicitud.idSolicitudImpresion}"
                        th:if="${solicitud.estado == 'APROBADO'}">Aprobar</button>
                </td>
            </tr>
        </tbody>
    </table>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const tabla = document.getElementById("tabla-solicitudes");

    // ‚úÖ Funci√≥n para marcar como impreso
    tabla.addEventListener("click", async (e) => {
        if (e.target.classList.contains("btn-impreso")) {
            const id = e.target.dataset.id;
            let estado = "IMPRESO";
            let motivo = "";
            const response = await fetch(`/operador/cambiarEstado/${id}?estado=${estado}&motivo=${encodeURIComponent(motivo)}`, {
                method: "POST"
            });

            if (response.ok) {
                Swal.fire({
                    icon: estado === "IMPRESO" ? 'success' : 'error',
                    title: `Solicitud ${estado.toLowerCase()}`,
                    text: estado === "RECHAZADO" ? `Motivo: ${motivo}` : '',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });

                const fila = e.target.closest("tr");
                fila.querySelector(".estado").innerText = estado;
                fila.querySelectorAll("button").forEach(b => b.remove());
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'Error al actualizar la solicitud',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        }
    });

    // ‚úÖ Funci√≥n para actualizar lista autom√°ticamente
    async function actualizarSolicitudes() {
        try {
            const response = await fetch('/operador/solicitudes');
            if (!response.ok) return;

            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            const nuevasFilas = doc.querySelectorAll("#tabla-solicitudes tr");
            const actualFilas = tabla.querySelectorAll("tr");

            if (nuevasFilas.length !== actualFilas.length) {
                tabla.innerHTML = ""; // Limpiar
                nuevasFilas.forEach(fila => tabla.appendChild(fila.cloneNode(true)));
                console.log("üîÑ Tabla actualizada autom√°ticamente");
            }
        } catch (err) {
            console.error("Error actualizando solicitudes:", err);
        }
    }

    // üîÅ Ejecutar actualizaci√≥n cada 5 segundos
    setInterval(actualizarSolicitudes, 5000);
});
</script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</body>
</html>
