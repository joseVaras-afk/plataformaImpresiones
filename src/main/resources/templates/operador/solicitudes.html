<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Solicitudes de Impresi√≥n</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>

<body class="container mt-4">
    <h2 class="mb-4 text-center">Solicitudes de Impresi√≥n</h2>

    <table class="table table-striped table-hover align-middle shadow-sm">
        <thead class="table-primary">
            <tr>
                <th>ID</th>
                <th>Profesor</th>
                <th>Curso</th>
                <th>Asignatura</th>
                <th>Cant. Copias</th>
                <th>Fecha Retiro</th>
                <th>Ambas Caras</th>
                <th>Archivo</th>
                <th>Imprimir</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>

        <tbody id="tabla-solicitudes" th:fragment="filas">
            <tr th:each="solicitud : ${solicitudes}" th:data-id="${solicitud.idSolicitudImpresion}">
                <td th:text="${solicitud.idSolicitudImpresion}"></td>
                <td th:text="${solicitud.funcionario.nombreFuncionario}"></td>
                <td th:text="${solicitud.curso}"></td>
                <td th:text="${solicitud.asignatura.nombreAsignatura}"></td>
                <td th:text="${solicitud.cantidadCopias}"></td>
                <td th:text="${#temporals.format(solicitud.fechaImpresion, 'dd-MM-yyyy')}"></td>
                <td th:text="${solicitud.ambasCaras}"></td>
                <td>
                    <a th:href="@{'/operador/descargar/' + ${solicitud.idSolicitudImpresion}}" class="btn btn-outline-primary btn-sm">
                         Descargar
                    </a>
                </td>
                <td>
                                     <a th:href="@{'/operador/imprimir/' + ${solicitud.idSolicitudImpresion}}" target="_blank"
                        class="btn btn-sm btn-success">
                        Imprimir
                    </a>
                </td>

                <td class="estado" th:text="${solicitud.estado}"></td>
                <td>
                    <button class="btn btn-success btn-impreso btn-sm"
                            th:data-id="${solicitud.idSolicitudImpresion}"
                            th:if="${solicitud.estado == 'APROBADO'}">
                        <i class="bi bi-check-circle"></i> Marcar como impreso
                    </button>
                </td>
            </tr>
        </tbody>
    </table>

    <script>
document.addEventListener("DOMContentLoaded", () => {
  const tabla = document.getElementById("tabla-solicitudes");
  const token  = document.querySelector('meta[name="_csrf"]').content;
  const header = document.querySelector('meta[name="_csrf_header"]').content;

  // Delegaci√≥n para Aprobar/Rechazar (tu c√≥digo actual sirve)
  tabla.addEventListener("click", async (e) => {
    if (e.target.classList.contains("btn-aprobar") || e.target.classList.contains("btn-rechazar")) {
      const id = e.target.dataset.id;
      let estado = "";
      let motivo = "";

      if (e.target.classList.contains("btn-aprobar")) {
        estado = "APROBADO";
      } else {
        estado = "RECHAZADO";
        const { value: texto } = await Swal.fire({
          title: 'Motivo del rechazo',
          input: 'textarea',
          inputPlaceholder: 'Escriba el motivo del rechazo...',
          showCancelButton: true,
          confirmButtonText: 'Enviar',
          cancelButtonText: 'Cancelar'
        });
        if (texto === undefined) return; // cancelado
        motivo = texto || "Sin motivo especificado";
      }

      const resp = await fetch(`/admin/cambiarEstado/${id}?estado=${encodeURIComponent(estado)}&motivo=${encodeURIComponent(motivo)}`, {
        method: "POST",
        headers: { [header]: token }
      });

      if (resp.ok) {
        Swal.fire({
          icon: estado === "APROBADO" ? 'success' : 'info',
          title: `Solicitud ${estado.toLowerCase()}`,
          toast: true, position: 'top-end', showConfirmButton: false, timer: 2000
        });
        const fila = e.target.closest("tr");
        fila.querySelector(".estado").innerText = estado;
        fila.querySelectorAll("button").forEach(b => b.remove());
      } else {
        Swal.fire({ icon: 'warning', title: 'Error al actualizar', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
      }
    }
  });

  // ‚úÖ ACTUALIZACI√ìN AUTOM√ÅTICA robusta
  async function actualizarSolicitudes() {
    try {
      const response = await fetch('/admin/solicitudes/json', {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });

      // si no est√° OK, no toques la tabla
      if (!response.ok) return;

      const ct = response.headers.get('content-type') || '';
      // si no es JSON (p.ej. login HTML), no toques la tabla
      if (!ct.includes('application/json')) return;

      const solicitudes = await response.json();

      // reconstruir tbody
      const frag = document.createDocumentFragment();

      solicitudes.forEach(s => {
        const tr = document.createElement('tr');
        // formato fecha (opcional)
        const fecha = s.fechaImpresion ? new Date(s.fechaImpresion).toLocaleDateString('es-CL') : '';

        tr.innerHTML = `
          <td>${s.idSolicitudImpresion}</td>
          <td>${s.funcionario?.nombreFuncionario ?? ''}</td>
          <td>${s.curso ?? ''}</td>
          <td>${s.asignatura?.nombreAsignatura ?? ''}</td>
          <td>${s.cantidadCopias ?? ''}</td>
          <td>${fecha}</td>
          <td>${s.ambasCaras ? 'S√≠' : 'No'}</td>
          <td><a href="/admin/descargar/${s.idSolicitudImpresion}">Ver Archivo</a></td>
          <td class="estado">${s.estado}</td>
          <td class="acciones"></td>
        `;

        // Botones solo si est√° PENDIENTE
        if (s.estado === 'PENDIENTE') {
          const acciones = tr.querySelector('.acciones');
          const btnOk = document.createElement('button');
          btnOk.className = 'btn btn-success btn-aprobar';
          btnOk.dataset.id = s.idSolicitudImpresion;
          btnOk.textContent = 'Aprobar';

          const btnNo = document.createElement('button');
          btnNo.className = 'btn btn-danger btn-rechazar ms-2';
          btnNo.dataset.id = s.idSolicitudImpresion;
          btnNo.textContent = 'Rechazar';

          acciones.append(btnOk, btnNo);
        }

        frag.appendChild(tr);
      });

      // solo aqu√≠ limpio y pego el nuevo contenido
      tabla.innerHTML = '';
      tabla.appendChild(frag);

    } catch (err) {
      // si hay error (p.ej. JSON parse), no toco la tabla actual
      console.error('No se pudo refrescar solicitudes:', err);
    }
  }

  // üîÅ Ejecutar actualizaci√≥n cada 5 segundos
  setInterval(actualizarSolicitudes, 5000);
});
</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</body>
</html>
