<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Solicitudes de Impresi√≥n</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="container mt-4">
    <h2 class="mb-4 text-center">Solicitudes de Impresi√≥n</h2>

    <table class="table table-striped table-hover align-middle shadow-sm">
        <thead class="table-primary">
            <tr>
                <th>ID</th>
                <th>Profesor</th>
                <th>Curso</th>
                <th>Asignatura</th>
                <th>Cant. Copias</th>
                <th>Fecha Retiro</th>
                <th>Archivo</th>
                <th>Imprimir</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>

        <tbody id="tabla-solicitudes" th:fragment="filas">
            <tr th:each="solicitud : ${solicitudes}" th:data-id="${solicitud.idSolicitudImpresion}">
                <td th:text="${solicitud.idSolicitudImpresion}"></td>
                <td th:text="${solicitud.funcionario.nombreFuncionario}"></td>
                <td th:text="${solicitud.curso}"></td>
                <td th:text="${solicitud.asignatura.nombreAsignatura}"></td>
                <td th:text="${solicitud.cantidadCopias}"></td>
                <td th:text="${#temporals.format(solicitud.fechaImpresion, 'dd-MM-yyyy')}"></td>
                <td>
                    <a th:href="@{'/operador/descargar/' + ${solicitud.idSolicitudImpresion}}" class="btn btn-outline-primary btn-sm">
                         Descargar
                    </a>
                </td>
                <td>
                                     <a th:href="@{'/operador/imprimir/' + ${solicitud.idSolicitudImpresion}}" target="_blank"
                        class="btn btn-sm btn-success">
                        Imprimir
                    </a>
                </td>

                <td class="estado" th:text="${solicitud.estado}"></td>
                <td>
                    <button class="btn btn-success btn-impreso btn-sm"
                            th:data-id="${solicitud.idSolicitudImpresion}"
                            th:if="${solicitud.estado == 'APROBADO'}">
                        <i class="bi bi-check-circle"></i> Marcar como impreso
                    </button>
                </td>
            </tr>
        </tbody>
    </table>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const tabla = document.getElementById("tabla-solicitudes");

        // ‚úÖ MARCAR COMO IMPRESO
        tabla.addEventListener("click", async (e) => {
            if (e.target.closest(".btn-impreso")) {
                const btn = e.target.closest(".btn-impreso");
                const id = btn.dataset.id;

                const response = await fetch(`/operador/marcarImpreso/${id}`, { method: "POST" });

                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Solicitud marcada como impresa',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });
                    actualizarSolicitudes(); // üîÑ actualiza la lista al instante
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al actualizar la solicitud',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
            }
        });

        // ‚úÖ ACTUALIZACI√ìN AUTOM√ÅTICA
        async function actualizarSolicitudes() {
            try {
                const response = await fetch('/operador/solicitudes/fragment', {
                    method: 'GET',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (!response.ok) return;

                const fragmentHtml = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(fragmentHtml, 'text/html');
                const nuevoTbody = doc.querySelector("tbody");

                if (nuevoTbody) {
                    tabla.innerHTML = nuevoTbody.innerHTML;
                    console.log("‚úÖ Lista de solicitudes actualizada");
                }
            } catch (err) {
                console.error("Error al actualizar solicitudes:", err);
            }
        }

        // üîÅ Actualiza cada 5 segundos
        setInterval(actualizarSolicitudes, 5000);
    });
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</body>
</html>
