<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de Solicitudes</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>
<body class="container mt-4">
    <h2>Gesti√≥n de Solicitudes de Impresi√≥n</h2>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Profesor</th>
                <th>Curso</th>
                <th>Asignatura</th>
                <th>Cantidad</th>
                <th>Fecha Retiro</th>
                <th>Archivo</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tabla-solicitudes" >
            <tr th:each="solicitud : ${solicitudes}" th:data-id="${solicitud.idSolicitudImpresion}">
                <td th:text="${solicitud.idSolicitudImpresion}"></td>
                <td th:text="${solicitud.funcionario.nombreFuncionario}"></td>
                <td th:text="${solicitud.curso}"></td>
                <td th:text="${solicitud.asignatura.nombreAsignatura}"></td>
                <td th:text="${solicitud.cantidadCopias}"></td>
                <td th:text="${solicitud.fechaImpresion}"></td>
                <td>
                    <a th:href="@{'/admin/descargar/' + ${solicitud.idSolicitudImpresion}}">Ver Archivo</a>
                </td>
                <td th:text="${solicitud.estado}" class="estado"></td>
                <td>
                    <button class="btn btn-success btn-aprobar" th:data-id="${solicitud.idSolicitudImpresion}"
                        th:if="${solicitud.estado == 'PENDIENTE'}">Aprobar</button>
                    <button class="btn btn-danger btn-rechazar" th:data-id="${solicitud.idSolicitudImpresion}"
                        th:if="${solicitud.estado == 'PENDIENTE'}">Rechazar</button>
                </td>
            </tr>
        </tbody>
    </table>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const tabla = document.getElementById("tabla-solicitudes");
    const token  = document.querySelector('meta[name="_csrf"]').content;
    const header = document.querySelector('meta[name="_csrf_header"]').content;
// Manejar botones Aprobar / Rechazar
    tabla.addEventListener("click", async (e) => {
        if (e.target.classList.contains("btn-aprobar") || e.target.classList.contains("btn-rechazar")) {
            const id = e.target.dataset.id;
            let estado = "";
            let motivo = "";

            if (e.target.classList.contains("btn-aprobar")) {
                estado = "APROBADO";
            } else {
                estado = "RECHAZADO";
                // Mostrar cuadro para motivo
                const { value: texto } = await Swal.fire({
                    title: 'Motivo del rechazo',
                    input: 'textarea',
                    inputPlaceholder: 'Escriba el motivo del rechazo...',
                    inputAttributes: {
                        'aria-label': 'Motivo del rechazo'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Enviar',
                    cancelButtonText: 'Cancelar'
                });

                if (texto === undefined) return; // Cancelado
                motivo = texto || "Sin motivo especificado";
            }

            const response = await fetch(`/admin/cambiarEstado/${id}?estado=${estado}&motivo=${encodeURIComponent(motivo)}`, {
                method: "POST", headers: { [header]: token  }
            });

            if (response.ok) {
                Swal.fire({
                    icon: estado === "APROBADO" ? 'success' : 'error',
                    title: `Solicitud ${estado.toLowerCase()}`,
                    text: estado === "RECHAZADO" ? `Motivo: ${motivo}` : '',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });

                const fila = e.target.closest("tr");
                fila.querySelector(".estado").innerText = estado;
                fila.querySelectorAll("button").forEach(b => b.remove());
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'Error al actualizar la solicitud',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        }
    });

    
     // ‚úÖ ACTUALIZACI√ìN AUTOM√ÅTICA
        async function actualizarSolicitudes() {
    const response = await fetch('/admin/solicitudes/json');
    if (!response.ok) return;

    const solicitudes = await response.json();

    tabla.innerHTML = ''; // Limpiar tabla

    solicitudes.forEach(s => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
            <td>${s.idSolicitudImpresion}</td>
            <td>${s.funcionario.nombreFuncionario}</td>
            <td>${s.curso}</td>
            <td>${s.asignatura.nombreAsignatura}</td>
            <td>${s.cantidadCopias}</td>
            <td>${s.fechaImpresion}</td>
            <td><a href="/admin/descargar/${s.idSolicitudImpresion}">Descargar</a></td>
            <td class="estado">${s.estado}</td>
            <td>
                    <button class="btn btn-success btn-aprobar" th:data-id="${solicitud.idSolicitudImpresion}"
                        th:if="${solicitud.estado == 'PENDIENTE'}">Aprobar</button>
                    <button class="btn btn-danger btn-rechazar" th:data-id="${solicitud.idSolicitudImpresion}"
                        th:if="${solicitud.estado == 'PENDIENTE'}">Rechazar</button>
         </td>`;
        tabla.appendChild(fila);
    });
}

    // üîÅ Ejecutar actualizaci√≥n cada 5 segundos
    setInterval(actualizarSolicitudes, 5000);
});
</script>

</body>
</html>
